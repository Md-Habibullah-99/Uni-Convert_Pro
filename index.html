<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Converter with Compression | Client-side Tool</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4cc9f0;
            --warning: #f72585;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: var(--gray);
            max-width: 700px;
            margin: 0 auto 20px;
        }
        
        .highlight {
            color: var(--secondary);
            font-weight: 600;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .upload-section, .preview-section {
            flex: 1;
            min-width: 300px;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .settings-panel {
            flex: 0 0 100%;
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-dark);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .section-title i {
            color: var(--secondary);
        }
        
        .drop-area {
            border: 3px dashed var(--primary);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            background-color: var(--gray-light);
            transition: all 0.3s;
            margin-bottom: 20px;
            cursor: pointer;
        }
        
        .drop-area:hover, .drop-area.highlight {
            background-color: #e3f2fd;
            border-color: var(--secondary);
        }
        
        .drop-area i {
            font-size: 3.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-size: 1rem;
            margin-top: 15px;
        }
        
        .upload-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .file-info {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: var(--border-radius);
            display: none;
        }
        
        .file-info.active {
            display: block;
        }
        
        .file-list {
            list-style-type: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-name {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-name i {
            color: var(--primary);
        }
        
        .file-size {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        .remove-file {
            color: var(--warning);
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.1rem;
        }
        
        .preview-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            padding: 15px;
            background-color: #fafafa;
            margin-bottom: 20px;
        }
        
        .preview-item {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
        }
        
        .preview-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .preview-content {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 150px;
            border-radius: 5px;
            display: block;
            margin: 0 auto;
        }
        
        .preview-text {
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.4;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .control-btn {
            flex: 1;
            min-width: 150px;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .reorder-btn {
            background-color: var(--gray-light);
            color: var(--dark);
        }
        
        .reorder-btn:hover {
            background-color: #dee2e6;
        }
        
        .convert-btn {
            background-color: var(--secondary);
            color: white;
        }
        
        .convert-btn:hover {
            background-color: #5a08a3;
            transform: translateY(-2px);
        }
        
        .download-btn {
            background-color: var(--success);
            color: white;
            display: none;
            text-decoration: none;
        }
        
        .download-btn:hover {
            background-color: #3aa8d0;
            transform: translateY(-2px);
        }
        
        .memory-warning {
            background-color: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            display: none;
            border-left: 4px solid #ffc107;
        }
        
        .memory-warning.active {
            display: block;
        }
        
        .warning-icon {
            display: inline-block;
            margin-right: 10px;
            color: #ffc107;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            h1 {
                font-size: 2.2rem;
            }
        }
        
        .file-type-icon {
            width: 24px;
            text-align: center;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
        }
        
        .move-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .move-btn:hover {
            color: var(--primary);
        }
        
        .move-btn:disabled {
            color: #ccc;
            cursor: not-allowed;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .setting-group {
            margin-bottom: 15px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--primary);
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            background: var(--gray-light);
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            background-color: white;
            font-size: 1rem;
            color: var(--dark);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .size-estimate {
            background-color: #e7f7ff;
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            font-size: 0.9rem;
            display: none;
        }
        
        .size-estimate.active {
            display: block;
        }
        
        .size-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        .compression-info {
            font-size: 0.85rem;
            color: var(--gray);
            margin-top: 5px;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid var(--gray-light);
            margin-bottom: 20px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            color: var(--primary);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            display: none;
        }
        
        .stats-panel.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .quality-badge {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--primary);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 5px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--gray-light);
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar.active {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PDF Converter with Compression</h1>
            <p class="subtitle">Convert images and text files to PDF with <span class="highlight">smart compression</span> to reduce file size. All processing happens in your browser.</p>
        </header>
        
        <div class="settings-panel">
            <div class="tab-buttons">
                <button class="tab-btn active" id="compressionTab">Compression Settings</button>
                <button class="tab-btn" id="layoutTab">Layout Settings</button>
            </div>
            
            <div class="tab-content active" id="compressionSettings">
                <div class="settings-grid">
                    <div class="setting-group">
                        <label class="setting-label">Image Quality <span class="quality-badge" id="qualityBadge">High</span></label>
                        <div class="slider-container">
                            <input type="range" id="qualitySlider" min="0.1" max="1" step="0.05" value="0.75">
                            <span class="slider-value" id="qualityValue">75%</span>
                        </div>
                        <p class="compression-info">Lower quality = smaller file size</p>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">Max Image Width</label>
                        <div class="slider-container">
                            <input type="range" id="widthSlider" min="400" max="2000" step="100" value="1600">
                            <span class="slider-value" id="widthValue">1600px</span>
                        </div>
                        <p class="compression-info">Larger images will be resized</p>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">Compression Mode</label>
                        <select id="compressionMode">
                            <option value="balanced">Balanced (Recommended)</option>
                            <option value="high">High Compression</option>
                            <option value="low">Low Compression</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">Page Size</label>
                        <select id="pageSize">
                            <option value="a4">A4 (Standard)</option>
                            <option value="letter">Letter (US)</option>
                        </select>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="optimizeImages" checked>
                    <label for="optimizeImages">Optimize images before adding to PDF</label>
                </div>
                
                <div class="size-estimate" id="sizeEstimate">
                    <p>Estimated PDF size: <span class="size-value" id="estimatedSize">0 KB</span></p>
                    <p class="compression-info">Based on current settings and uploaded files</p>
                </div>
                
                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="tab-content" id="layoutSettings">
                <div class="settings-grid">
                    <div class="setting-group">
                        <label class="setting-label">Page Orientation</label>
                        <select id="pageOrientation">
                            <option value="portrait">Portrait</option>
                            <option value="landscape">Landscape</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">Image Fit Mode</label>
                        <select id="imageFit">
                            <option value="fit">Fit to page</option>
                            <option value="fill">Fill page (crop)</option>
                            <option value="original">Original size</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label class="setting-label">Text Font Size</label>
                        <div class="slider-container">
                            <input type="range" id="fontSlider" min="8" max="16" step="1" value="12">
                            <span class="slider-value" id="fontValue">12px</span>
                        </div>
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="addPageNumbers" checked>
                    <label for="addPageNumbers">Add page numbers</label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="addFileNameHeaders" checked>
                    <label for="addFileNameHeaders">Add file names as headers</label>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <section class="upload-section">
                <h2 class="section-title"><i class="fas fa-cloud-upload-alt"></i> Upload Files</h2>
                
                <div class="drop-area" id="dropArea">
                    <i class="fas fa-file-upload"></i>
                    <h3>Drag & Drop Files Here</h3>
                    <p>or click to browse</p>
                    <p>Supports images (JPG, PNG, WebP, etc.) and text files</p>
                    
                    <input type="file" class="file-input" id="fileInput" multiple accept=".jpg,.jpeg,.png,.webp,.gif,.bmp,.txt,.text">
                    <button class="upload-btn" id="browseBtn">Browse Files</button>
                </div>
                
                <div class="file-info" id="fileInfo">
                    <h4>Selected Files:</h4>
                    <ul class="file-list" id="fileList"></ul>
                </div>
                
                <div class="memory-warning" id="memoryWarning">
                    <span class="warning-icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <strong>Large File Detected:</strong> Files over 5MB will be compressed to reduce memory usage.
                </div>
                
                <div class="stats-panel" id="statsPanel">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="totalFiles">0</div>
                            <div class="stat-label">Total Files</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalSize">0 KB</div>
                            <div class="stat-label">Original Size</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="estimatedPDF">0 KB</div>
                            <div class="stat-label">Estimated PDF</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="compressionRate">0%</div>
                            <div class="stat-label">Size Reduction</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="preview-section">
                <h2 class="section-title"><i class="fas fa-eye"></i> Preview & Arrange</h2>
                
                <div class="preview-container" id="previewContainer">
                    <p id="emptyPreview">No files added yet. Upload files to see preview here.</p>
                </div>
                
                <div class="controls">
                    <button class="control-btn reorder-btn" id="reorderBtn">
                        <i class="fas fa-random"></i> Reorder Files
                    </button>
                    
                    <button class="control-btn convert-btn" id="convertBtn">
                        <i class="fas fa-file-pdf"></i> Convert to PDF
                    </button>
                    
                    <a class="control-btn download-btn" id="downloadBtn" download="compressed_document.pdf">
                        <i class="fas fa-download"></i> Download PDF
                    </a>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loadingText">Optimizing and converting files to PDF...</p>
                    <p id="loadingDetail">Compressing images for smaller file size.</p>
                </div>
            </section>
        </div>
        
        <footer>
            <p>Client-side PDF Converter with Smart Compression &bull; No data leaves your computer</p>
            <p>Uses PDF-Lib for reliable PDF generation with image compression</p>
        </footer>
    </div>

    <script>
        // Global variables
        let files = [];
        let finalPdfBytes = null;
        const MAX_FILE_SIZE_NORMAL = 5 * 1024 * 1024; // 5MB
        const MAX_TOTAL_SIZE = 100 * 1024 * 1024; // 100MB
        const MAX_FILES = 30;
        
        // Compression settings
        let settings = {
            quality: 0.75,
            maxWidth: 1600,
            compressionMode: 'balanced',
            pageSize: 'a4',
            optimizeImages: true,
            orientation: 'portrait',
            imageFit: 'fit',
            fontSize: 12,
            pageNumbers: true,
            fileHeaders: true
        };
        
        // DOM Elements
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileList = document.getElementById('fileList');
        const previewContainer = document.getElementById('previewContainer');
        const emptyPreview = document.getElementById('emptyPreview');
        const reorderBtn = document.getElementById('reorderBtn');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const loadingDetail = document.getElementById('loadingDetail');
        const memoryWarning = document.getElementById('memoryWarning');
        const statsPanel = document.getElementById('statsPanel');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        
        // Settings elements
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const qualityBadge = document.getElementById('qualityBadge');
        const widthSlider = document.getElementById('widthSlider');
        const widthValue = document.getElementById('widthValue');
        const compressionMode = document.getElementById('compressionMode');
        const pageSize = document.getElementById('pageSize');
        const optimizeImages = document.getElementById('optimizeImages');
        const sizeEstimate = document.getElementById('sizeEstimate');
        const estimatedSize = document.getElementById('estimatedSize');
        
        // Stats elements
        const totalFiles = document.getElementById('totalFiles');
        const totalSize = document.getElementById('totalSize');
        const estimatedPDF = document.getElementById('estimatedPDF');
        const compressionRate = document.getElementById('compressionRate');
        
        // Initialize event listeners
        function init() {
            browseBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            dropArea.addEventListener('dragover', handleDragOver);
            dropArea.addEventListener('drop', handleDrop);
            convertBtn.addEventListener('click', convertToPDF);
            reorderBtn.addEventListener('click', toggleReorderMode);
            
            // Settings event listeners
            qualitySlider.addEventListener('input', updateQuality);
            widthSlider.addEventListener('input', updateMaxWidth);
            compressionMode.addEventListener('change', updateCompressionMode);
            
            // Tab event listeners
            document.getElementById('compressionTab').addEventListener('click', () => switchTab('compression'));
            document.getElementById('layoutTab').addEventListener('click', () => switchTab('layout'));
            
            // Load saved settings from localStorage
            loadSettings();
            
            // Update UI with initial settings
            updateQuality();
            updateMaxWidth();
        }
        
        // Load saved settings from localStorage
        function loadSettings() {
            const savedSettings = localStorage.getItem('pdfConverterSettings');
            if (savedSettings) {
                const saved = JSON.parse(savedSettings);
                settings = { ...settings, ...saved };
                
                // Update UI elements with saved settings
                qualitySlider.value = settings.quality;
                widthSlider.value = settings.maxWidth;
                compressionMode.value = settings.compressionMode;
                pageSize.value = settings.pageSize;
                optimizeImages.checked = settings.optimizeImages;
                
                updateQuality();
                updateMaxWidth();
            }
        }
        
        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('pdfConverterSettings', JSON.stringify(settings));
        }
        
        // Switch between tabs
        function switchTab(tab) {
            const compressionTab = document.getElementById('compressionTab');
            const layoutTab = document.getElementById('layoutTab');
            const compressionSettings = document.getElementById('compressionSettings');
            const layoutSettings = document.getElementById('layoutSettings');
            
            if (tab === 'compression') {
                compressionTab.classList.add('active');
                layoutTab.classList.remove('active');
                compressionSettings.classList.add('active');
                layoutSettings.classList.remove('active');
            } else {
                compressionTab.classList.remove('active');
                layoutTab.classList.add('active');
                compressionSettings.classList.remove('active');
                layoutSettings.classList.add('active');
            }
        }
        
        // Update quality setting
        function updateQuality() {
            settings.quality = parseFloat(qualitySlider.value);
            qualityValue.textContent = `${Math.round(settings.quality * 100)}%`;
            
            // Update quality badge
            if (settings.quality >= 0.8) {
                qualityBadge.textContent = 'High';
                qualityBadge.style.backgroundColor = '#4caf50';
            } else if (settings.quality >= 0.5) {
                qualityBadge.textContent = 'Medium';
                qualityBadge.style.backgroundColor = '#ff9800';
            } else {
                qualityBadge.textContent = 'Low';
                qualityBadge.style.backgroundColor = '#f44336';
            }
            
            updateSizeEstimate();
            saveSettings();
        }
        
        // Update max width setting
        function updateMaxWidth() {
            settings.maxWidth = parseInt(widthSlider.value);
            widthValue.textContent = `${settings.maxWidth}px`;
            updateSizeEstimate();
            saveSettings();
        }
        
        // Update compression mode
        function updateCompressionMode() {
            settings.compressionMode = compressionMode.value;
            updateSizeEstimate();
            saveSettings();
        }
        
        // Handle drag over event
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.add('highlight');
        }
        
        // Handle drop event
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropArea.classList.remove('highlight');
            
            const droppedFiles = e.dataTransfer.files;
            processFiles(droppedFiles);
        }
        
        // Handle file selection via input
        function handleFileSelect(e) {
            const selectedFiles = e.target.files;
            processFiles(selectedFiles);
        }
        
        // Process uploaded files
        function processFiles(fileArray) {
            // Convert FileList to array
            const newFiles = Array.from(fileArray);
            
            // Check if adding new files would exceed limits
            if (files.length + newFiles.length > MAX_FILES) {
                alert(`You can only upload up to ${MAX_FILES} files. You already have ${files.length} files.`);
                return;
            }
            
            // Calculate total size
            let totalSize = files.reduce((sum, file) => sum + file.size, 0);
            
            // Check each new file
            for (const file of newFiles) {
                // Check file type
                const fileType = file.type;
                const fileName = file.name.toLowerCase();
                
                // Check if file is supported
                const isImage = fileType.startsWith('image/');
                const isText = fileType === 'text/plain' || fileName.endsWith('.txt');
                
                if (!isImage && !isText) {
                    alert(`File "${file.name}" is not supported. Please upload images or text files only.`);
                    continue;
                }
                
                // Check individual file size
                if (file.size > 15 * 1024 * 1024) {
                    alert(`File "${file.name}" is too large (max 15MB).`);
                    continue;
                }
                
                // Check total size
                totalSize += file.size;
                if (totalSize > MAX_TOTAL_SIZE) {
                    alert(`Adding "${file.name}" would exceed the total size limit of 100MB.`);
                    continue;
                }
                
                // Add file to array with metadata
                files.push({
                    file: file,
                    id: Date.now() + Math.random(),
                    type: isImage ? 'image' : 'text',
                    name: file.name,
                    size: file.size,
                    preview: null,
                    compressed: false,
                    compressedSize: file.size
                });
            }
            
            // Show memory warning if any file is large
            const hasLargeFile = files.some(f => f.size > MAX_FILE_SIZE_NORMAL);
            memoryWarning.classList.toggle('active', hasLargeFile);
            
            // Update UI
            updateFileList();
            updatePreview();
            updateStats();
            updateSizeEstimate();
            fileInput.value = ''; // Reset input
            
            // Enable convert button
            convertBtn.disabled = files.length === 0;
        }
        
        // Update file list UI
        function updateFileList() {
            if (files.length === 0) {
                fileInfo.classList.remove('active');
                statsPanel.classList.remove('active');
                return;
            }
            
            fileInfo.classList.add('active');
            statsPanel.classList.add('active');
            fileList.innerHTML = '';
            
            files.forEach((fileData, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.dataset.id = fileData.id;
                
                // Format file size
                const size = formatFileSize(fileData.size);
                
                li.innerHTML = `
                    <div class="file-name">
                        <i class="fas ${fileData.type === 'image' ? 'fa-file-image' : 'fa-file-alt'}"></i>
                        <span>${fileData.name}</span>
                        ${fileData.compressed ? '<span style="color: green; font-size: 0.8rem;">(compressed)</span>' : ''}
                    </div>
                    <div class="file-size">${size}</div>
                    <button class="remove-file" onclick="removeFile('${fileData.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                fileList.appendChild(li);
            });
        }
        
        // Remove file from list
        function removeFile(id) {
            files = files.filter(f => f.id !== id);
            updateFileList();
            updatePreview();
            updateStats();
            updateSizeEstimate();
            
            // Hide memory warning if no large files remain
            const hasLargeFile = files.some(f => f.size > MAX_FILE_SIZE_NORMAL);
            memoryWarning.classList.toggle('active', hasLargeFile);
            
            // Disable convert button if no files
            convertBtn.disabled = files.length === 0;
        }
        
        // Update preview section
        function updatePreview() {
            if (files.length === 0) {
                emptyPreview.style.display = 'block';
                previewContainer.innerHTML = '<p id="emptyPreview">No files added yet. Upload files to see preview here.</p>';
                return;
            }
            
            emptyPreview.style.display = 'none';
            previewContainer.innerHTML = '';
            
            files.forEach((fileData, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.dataset.id = fileData.id;
                
                // Generate preview content based on file type
                if (fileData.type === 'image') {
                    // Create image preview
                    if (!fileData.preview) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.className = 'preview-img';
                            
                            const contentDiv = previewItem.querySelector('.preview-content');
                            if (contentDiv) {
                                contentDiv.innerHTML = '';
                                contentDiv.appendChild(img);
                            }
                        };
                        reader.readAsDataURL(fileData.file);
                        fileData.preview = 'loading';
                    }
                } else {
                    // Create text preview
                    if (!fileData.preview) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const text = e.target.result;
                            // Limit preview length
                            const previewText = text.length > 1000 ? text.substring(0, 1000) + '...' : text;
                            
                            const contentDiv = previewItem.querySelector('.preview-content');
                            if (contentDiv) {
                                contentDiv.innerHTML = `<div class="preview-text">${escapeHtml(previewText)}</div>`;
                            }
                        };
                        reader.readAsText(fileData.file);
                        fileData.preview = 'loading';
                    }
                }
                
                previewItem.innerHTML = `
                    <div class="preview-item-header">
                        <div class="file-name">
                            <span class="file-type-icon">
                                <i class="fas ${fileData.type === 'image' ? 'fa-image' : 'fa-file-alt'}"></i>
                            </span>
                            <span>${fileData.name}</span>
                        </div>
                        <div class="item-actions">
                            <button class="move-btn" onclick="moveItemUp('${fileData.id}')" ${index === 0 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="move-btn" onclick="moveItemDown('${fileData.id}')" ${index === files.length - 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button class="remove-file" onclick="removeFile('${fileData.id}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="preview-content">
                        ${fileData.preview && fileData.preview !== 'loading' ? 
                            (fileData.type === 'image' ? 
                                `<img src="${fileData.preview}" class="preview-img" alt="${fileData.name}">` : 
                                `<div class="preview-text">${escapeHtml(fileData.preview)}</div>`) : 
                            '<p>Loading preview...</p>'}
                    </div>
                `;
                
                previewContainer.appendChild(previewItem);
            });
        }
        
        // Move item up in the list
        function moveItemUp(id) {
            const index = files.findIndex(f => f.id === id);
            if (index > 0) {
                // Swap with previous item
                [files[index], files[index-1]] = [files[index-1], files[index]];
                updatePreview();
                updateFileList();
            }
        }
        
        // Move item down in the list
        function moveItemDown(id) {
            const index = files.findIndex(f => f.id === id);
            if (index < files.length - 1) {
                // Swap with next item
                [files[index], files[index+1]] = [files[index+1], files[index]];
                updatePreview();
                updateFileList();
            }
        }
        
        // Toggle reorder mode
        function toggleReorderMode() {
            const moveButtons = document.querySelectorAll('.move-btn');
            const isHidden = moveButtons[0].style.display === 'none';
            
            moveButtons.forEach(btn => {
                btn.style.display = isHidden ? 'inline-block' : 'none';
            });
            
            reorderBtn.innerHTML = isHidden ? 
                '<i class="fas fa-random"></i> Done Reordering' : 
                '<i class="fas fa-random"></i> Reorder Files';
        }
        
        // Update statistics panel
        function updateStats() {
            if (files.length === 0) {
                statsPanel.classList.remove('active');
                return;
            }
            
            const totalFilesCount = files.length;
            const originalTotalSize = files.reduce((sum, f) => sum + f.size, 0);
            
            totalFiles.textContent = totalFilesCount;
            totalSize.textContent = formatFileSize(originalTotalSize);
            
            // Estimate compressed size
            let estimatedTotalSize = 0;
            files.forEach(file => {
                if (file.type === 'image') {
                    // Estimate image compression
                    let compressionFactor = 0.5; // Default for balanced
                    if (settings.compressionMode === 'high') compressionFactor = 0.3;
                    if (settings.compressionMode === 'low') compressionFactor = 0.8;
                    
                    // Apply quality setting
                    compressionFactor *= settings.quality;
                    
                    estimatedTotalSize += file.size * compressionFactor;
                } else {
                    // Text files add minimal size
                    estimatedTotalSize += file.size * 0.05; // Text compression is very efficient
                }
            });
            
            // Add PDF overhead (about 20KB)
            estimatedTotalSize += 20 * 1024;
            
            estimatedPDF.textContent = formatFileSize(estimatedTotalSize);
            
            // Calculate compression rate
            const reduction = Math.max(0, 100 - (estimatedTotalSize / originalTotalSize * 100));
            compressionRate.textContent = `${Math.round(reduction)}%`;
        }
        
        // Update size estimate
        function updateSizeEstimate() {
            if (files.length === 0) {
                sizeEstimate.classList.remove('active');
                return;
            }
            
            sizeEstimate.classList.add('active');
            updateStats();
        }
        
        // Image compression function (from your code)
        async function compressImage(file, maxSize = null, quality = null) {
            const img = new Image();
            img.src = URL.createObjectURL(file);
            await img.decode();
            
            let { width, height } = img;
            const maxWidth = maxSize || settings.maxWidth;
            const qualityLevel = quality || settings.quality;
            
            // Calculate scale to fit within max dimensions
            const scale = Math.min(1, maxWidth / Math.max(width, height));
            
            width = Math.round(width * scale);
            height = Math.round(height * scale);
            
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext("2d");
            
            // Apply compression settings
            if (settings.compressionMode === 'high') {
                // For high compression, use lower quality and faster drawing
                ctx.imageSmoothingEnabled = false;
                ctx.imageSmoothingQuality = 'low';
            }
            
            ctx.drawImage(img, 0, 0, width, height);
            
            const blob = await new Promise(resolve =>
                canvas.toBlob(resolve, "image/jpeg", qualityLevel)
            );
            
            URL.revokeObjectURL(img.src);
            return await blob.arrayBuffer();
        }
        
        // Convert files to PDF with compression
        async function convertToPDF() {
            if (files.length === 0) {
                alert('Please add at least one file to convert.');
                return;
            }
            
            // Show loading indicator
            loading.classList.add('active');
            progressBar.classList.add('active');
            convertBtn.disabled = true;
            downloadBtn.style.display = 'none';
            
            try {
                loadingText.textContent = "Creating PDF document...";
                loadingDetail.textContent = "Initializing PDF library";
                
                // Create PDF document
                const pdfDoc = await PDFLib.PDFDocument.create();
                const font = await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
                const fontBold = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);
                
                // Determine page size
                const pageSize = settings.pageSize === 'a4' ? [595.28, 841.89] : [612, 792];
                const isLandscape = settings.orientation === 'landscape';
                const [pageWidth, pageHeight] = isLandscape ? [pageSize[1], pageSize[0]] : pageSize;
                
                // Process each file
                for (let i = 0; i < files.length; i++) {
                    const fileData = files[i];
                    const progress = ((i / files.length) * 100).toFixed(0);
                    progressFill.style.width = `${progress}%`;
                    
                    loadingText.textContent = `Processing file ${i+1} of ${files.length}`;
                    loadingDetail.textContent = `Compressing: ${fileData.name}`;
                    
                    // Update progress every few files to keep UI responsive
                    if (i % 2 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                    
                    if (fileData.type === 'image') {
                        // Compress image
                        let imageBytes;
                        
                        if (settings.optimizeImages) {
                            // Adjust quality based on compression mode
                            let quality = settings.quality;
                            if (settings.compressionMode === 'high') quality *= 0.6;
                            if (settings.compressionMode === 'low') quality = Math.min(quality * 1.2, 1);
                            
                            imageBytes = await compressImage(fileData.file, settings.maxWidth, quality);
                        } else {
                            // Use original image
                            imageBytes = await fileData.file.arrayBuffer();
                        }
                        
                        // Embed image in PDF
                        let image;
                        try {
                            // Try JPEG first
                            image = await pdfDoc.embedJpg(imageBytes);
                        } catch (e) {
                            // If JPEG fails, try PNG
                            try {
                                image = await pdfDoc.embedPng(imageBytes);
                            } catch (e2) {
                                console.error("Failed to embed image:", e2);
                                // Add placeholder text instead
                                addTextPage(pdfDoc, font, fontBold, pageWidth, pageHeight, 
                                           `[Image: ${fileData.name} - Could not be processed]`);
                                continue;
                            }
                        }
                        
                        // Add page with image
                        const page = pdfDoc.addPage([pageWidth, pageHeight]);
                        
                        // Calculate image dimensions based on fit mode
                        let imgWidth, imgHeight, x, y;
                        
                        const imgAspect = image.width / image.height;
                        const pageAspect = pageWidth / pageHeight;
                        
                        if (settings.imageFit === 'fill') {
                            // Fill page (may crop)
                            if (imgAspect > pageAspect) {
                                // Image is wider than page
                                imgHeight = pageHeight;
                                imgWidth = imgHeight * imgAspect;
                                x = (pageWidth - imgWidth) / 2;
                                y = 0;
                            } else {
                                // Image is taller than page
                                imgWidth = pageWidth;
                                imgHeight = imgWidth / imgAspect;
                                x = 0;
                                y = (pageHeight - imgHeight) / 2;
                            }
                        } else if (settings.imageFit === 'original') {
                            // Original size
                            const scale = 72/96; // Convert pixels to points
                            imgWidth = image.width * scale;
                            imgHeight = image.height * scale;
                            x = (pageWidth - imgWidth) / 2;
                            y = (pageHeight - imgHeight) / 2;
                        } else {
                            // Fit to page (default)
                            const scale = Math.min(pageWidth / image.width, pageHeight / image.height);
                            imgWidth = image.width * scale;
                            imgHeight = image.height * scale;
                            x = (pageWidth - imgWidth) / 2;
                            y = (pageHeight - imgHeight) / 2;
                        }
                        
                        // Draw image on page
                        page.drawImage(image, {
                            x,
                            y,
                            width: imgWidth,
                            height: imgHeight
                        });
                        
                        // Add file name if enabled
                        if (settings.fileHeaders) {
                            page.drawText(fileData.name, {
                                x: 20,
                                y: pageHeight - 20,
                                size: 10,
                                font: fontBold,
                                color: PDFLib.rgb(0.3, 0.3, 0.3)
                            });
                        }
                        
                    } else {
                        // Process text file
                        const text = await readFileAsText(fileData.file);
                        
                        // Split text into lines
                        const lines = text.split("\n");
                        let currentPage = pdfDoc.addPage([pageWidth, pageHeight]);
                        let y = pageHeight - 40;
                        let lineIndex = 0;
                        
                        // Add file name header if enabled
                        if (settings.fileHeaders) {
                            currentPage.drawText(fileData.name, {
                                x: 20,
                                y: pageHeight - 20,
                                size: 12,
                                font: fontBold,
                                color: PDFLib.rgb(0.2, 0.2, 0.2)
                            });
                            y -= 20;
                        }
                        
                        while (lineIndex < lines.length) {
                            const line = lines[lineIndex];
                            
                            // Check if we need a new page
                            if (y < 40) {
                                currentPage = pdfDoc.addPage([pageWidth, pageHeight]);
                                y = pageHeight - 40;
                            }
                            
                            // Draw line
                            currentPage.drawText(line, {
                                x: 40,
                                y,
                                size: settings.fontSize,
                                font,
                                color: PDFLib.rgb(0, 0, 0)
                            });
                            
                            y -= (settings.fontSize * 1.2);
                            lineIndex++;
                        }
                    }
                }
                
                // Add page numbers if enabled
                if (settings.pageNumbers) {
                    const pages = pdfDoc.getPages();
                    pages.forEach((page, index) => {
                        const { width, height } = page.getSize();
                        page.drawText(`Page ${index + 1}`, {
                            x: width - 60,
                            y: 20,
                            size: 10,
                            font,
                            color: PDFLib.rgb(0.5, 0.5, 0.5)
                        });
                    });
                }
                
                // Complete progress bar
                progressFill.style.width = '100%';
                loadingText.textContent = "Finalizing PDF...";
                loadingDetail.textContent = "Saving document";
                
                // Save PDF
                finalPdfBytes = await pdfDoc.save();
                
                // Create download link
                const pdfBlob = new Blob([finalPdfBytes], { type: "application/pdf" });
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Show final file size
                const finalSize = formatFileSize(pdfBlob.size);
                loadingText.innerHTML = `Conversion complete!`;
                loadingDetail.innerHTML = `Final PDF size: <strong>${finalSize}</strong>`;
                
                // Update download button
                downloadBtn.href = pdfUrl;
                downloadBtn.style.display = 'flex';
                downloadBtn.download = `compressed_document_${Date.now()}.pdf`;
                
                // Update stats with actual size
                const originalTotalSize = files.reduce((sum, f) => sum + f.size, 0);
                const actualReduction = Math.max(0, 100 - (pdfBlob.size / originalTotalSize * 100));
                compressionRate.textContent = `${Math.round(actualReduction)}%`;
                estimatedPDF.textContent = finalSize;
                
                // Scroll to download button
                setTimeout(() => {
                    downloadBtn.scrollIntoView({ behavior: 'smooth' });
                }, 500);
                
            } catch (error) {
                console.error('Error converting to PDF:', error);
                loadingText.textContent = "Error during conversion";
                loadingDetail.textContent = error.message || "Please try again with smaller files or adjust compression settings.";
                alert('Error converting files to PDF. Please try again with smaller files or adjust compression settings.');
            } finally {
                // Hide loading indicator after a delay
                setTimeout(() => {
                    loading.classList.remove('active');
                    progressBar.classList.remove('active');
                    progressFill.style.width = '0%';
                    convertBtn.disabled = false;
                }, 2000);
            }
        }
        
        // Helper function to add a text page
        function addTextPage(pdfDoc, font, fontBold, pageWidth, pageHeight, text) {
            const page = pdfDoc.addPage([pageWidth, pageHeight]);
            page.drawText(text, {
                x: 40,
                y: pageHeight / 2,
                size: 12,
                font,
                color: PDFLib.rgb(0.5, 0.5, 0.5)
            });
        }
        
        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(e);
                reader.readAsText(file);
            });
        }
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>